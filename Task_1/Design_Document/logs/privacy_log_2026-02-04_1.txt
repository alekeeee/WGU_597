================================================================================
HEALTH_TRACKER DATABASE - Privacy and Security Measures
================================================================================

Generated: 2026-02-04
Database: health_tracker (PostgreSQL)
Topic: Privacy and security measures for healthcare database design

================================================================================

┌──────────────────────────────────────────────────────────────────────────────┐
│ EXCHANGE 1                                                                   │
└──────────────────────────────────────────────────────────────────────────────┘

► USER PROMPT:
────────────────────────────────────────
In the health_tracker database, Outline the privacy and security measures that should be implemented in the proposed database design

◄ CLAUDE RESPONSE:
────────────────────────────────────────
Based on the schema, this database handles **Protected Health Information (PHI)** and **Personally Identifiable Information (PII)**, making it subject to regulations like HIPAA. Here are the privacy and security measures that should be implemented:

## 1. Access Control

**Role-Based Access Control (RBAC)**
```sql
-- Create distinct roles with minimum necessary privileges
CREATE ROLE patient_user;           -- Users viewing their own data
CREATE ROLE practitioner_role;      -- Healthcare providers
CREATE ROLE admin_role;             -- Database administrators
CREATE ROLE analytics_role;         -- De-identified data access only

-- Grant specific table permissions per role
GRANT SELECT ON User_Info, Observation TO patient_user;
GRANT SELECT, INSERT, UPDATE ON Appointment, Patient_Condition TO practitioner_role;
```

**Row-Level Security (RLS)**
```sql
-- Ensure users can only access their own records
ALTER TABLE Observation ENABLE ROW LEVEL SECURITY;

CREATE POLICY user_own_data ON Observation
    FOR ALL TO patient_user
    USING (user_id = current_setting('app.current_user_id')::INT);
```

## 2. Data Encryption

| Layer | Implementation |
|-------|----------------|
| **At Rest** | Enable PostgreSQL Transparent Data Encryption (TDE) or use encrypted storage volumes |
| **In Transit** | Require SSL/TLS connections (`ssl = on` in postgresql.conf) |
| **Column-Level** | Use `pgcrypto` for highly sensitive fields |

```sql
-- Example: Encrypt SSN or sensitive identifiers if added
CREATE EXTENSION pgcrypto;

-- Store encrypted, retrieve with application-level key
UPDATE User_Info SET email_address = pgp_sym_encrypt(email_address, 'encryption_key');
```

## 3. Authentication Hardening

The schema already stores `password_hash` (good practice). Ensure:

- **Strong hashing algorithm**: Use bcrypt, scrypt, or Argon2 (not MD5/SHA1)
- **Connection authentication**: Configure `pg_hba.conf` to require password + SSL
- **Multi-factor authentication**: Implement at the application layer
- **Session management**: Enforce timeouts for inactive connections

```sql
-- Enforce password complexity via application or pg_hba.conf
-- Set connection limits
ALTER ROLE patient_user CONNECTION LIMIT 5;
```

## 4. Audit Logging

**Track all access to PHI:**
```sql
-- Enable PostgreSQL audit logging
-- In postgresql.conf:
-- log_statement = 'all'
-- log_connections = on
-- log_disconnections = on

-- Or use pgAudit extension for granular control
CREATE EXTENSION pgaudit;
SET pgaudit.log = 'read, write, ddl';
```

**Custom audit table for healthcare compliance:**
```sql
CREATE TABLE Audit_Log (
    log_id BIGSERIAL PRIMARY KEY,
    table_name VARCHAR(100),
    operation VARCHAR(20),
    user_id INT,
    performed_by VARCHAR(100),
    performed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    old_values JSONB,
    new_values JSONB,
    ip_address INET
);
```

## 5. Data Minimization & Retention

| Policy | Implementation |
|--------|----------------|
| **Minimum necessary** | Only collect data required for treatment/operations |
| **Retention limits** | Auto-archive or delete data after retention period |
| **De-identification** | Create views for analytics that strip PII |

```sql
-- De-identified view for analytics
CREATE VIEW Observation_Anonymized AS
SELECT
    observation_id,
    metric,
    date_trunc('month', date_time) AS observation_month,
    value
FROM Observation;
-- Excludes user_id, profile_id, and precise timestamps

GRANT SELECT ON Observation_Anonymized TO analytics_role;
```

## 6. Input Validation & Injection Prevention

- **Parameterized queries**: Never concatenate user input into SQL
- **Check constraints**: Already present (e.g., `check_device_source`)
- **Data type enforcement**: Schema uses appropriate types (DATE, INT, etc.)

```sql
-- Add constraints for data integrity
ALTER TABLE "User" ADD CONSTRAINT valid_birthdate
    CHECK (birthdate <= CURRENT_DATE AND birthdate > '1900-01-01');

ALTER TABLE Appointment ADD CONSTRAINT valid_datetime
    CHECK (end_datetime > start_datetime);
```

## 7. Backup & Disaster Recovery

| Measure | Description |
|---------|-------------|
| **Encrypted backups** | Use `pg_dump` with encryption or encrypted storage |
| **Off-site storage** | Store backups in separate geographic location |
| **Regular testing** | Verify backup restoration quarterly |
| **Point-in-time recovery** | Enable WAL archiving |

```bash
# Encrypted backup example
pg_dump health_tracker | gpg --encrypt -r backup@org.com > backup.sql.gpg
```

## 8. Network Security

- **Firewall rules**: Restrict database port (5432) to application servers only
- **VPN/Private network**: Database should not be publicly accessible
- **Connection limits**: Prevent brute-force attacks

```sql
-- In pg_hba.conf: restrict to specific IP ranges
# TYPE  DATABASE    USER        ADDRESS         METHOD
hostssl health_tracker all       10.0.0.0/8      scram-sha-256
```

## 9. HIPAA-Specific Requirements

| Requirement | Implementation |
|-------------|----------------|
| **Business Associate Agreements** | Required for any third-party with database access |
| **Breach notification** | Audit logs must support incident investigation |
| **Patient access rights** | Users must be able to request their data export |
| **Unique user identification** | `user_id` serves as unique identifier |

```sql
-- Data export function for patient access requests
CREATE OR REPLACE FUNCTION export_user_data(p_user_id INT)
RETURNS TABLE (category TEXT, data JSONB) AS $$
BEGIN
    RETURN QUERY
    SELECT 'profile'::TEXT, row_to_json(u.*)::JSONB FROM "User" u WHERE user_id = p_user_id
    UNION ALL
    SELECT 'observations'::TEXT, jsonb_agg(row_to_json(o.*)) FROM Observation o WHERE user_id = p_user_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## 10. Summary Checklist

| Category | Measures |
|----------|----------|
| **Access Control** | RBAC, Row-Level Security, least privilege |
| **Encryption** | TLS in transit, encryption at rest, column-level for sensitive data |
| **Authentication** | Strong password hashing, MFA, session timeouts |
| **Auditing** | pgAudit, custom audit tables, log retention |
| **Data Protection** | Minimization, retention policies, de-identification |
| **Network** | Firewall, VPN, SSL-only connections |
| **Compliance** | HIPAA safeguards, breach procedures, patient access |

These measures address the three HIPAA safeguard categories: **Administrative** (policies, access controls), **Physical** (encrypted backups, secure hosting), and **Technical** (encryption, audit logs, authentication).

================================================================================
END OF SESSION
================================================================================
